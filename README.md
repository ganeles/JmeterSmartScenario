# JmeterSmartScenario

Этот модуль позволяет "в два клика" менять параметры вашего Jmeter-теста.
Для изменения параметров нужно заполнить следующие ячейки:
1) Время разгона на первую ступень теста
2) Процент профиля на первой ступени теста
3) Длительность первой ступени теста

4) Время разгона на каждую следующую ступень теста
5) Процент профиля, добавляющийся на каждой следующей ступени теста
6) Длительность каждой следующую ступени теста

![Параметры теста](./images/pic1.png "Параметры теста")
После этого запустить тест, и наслаждаться результатами.

![Результаты теста](./images/pic2.png "Результаты теста")

# Зачем это нужно?
Мы запускаем множество тестов.
Чаще всего это тесты на "Поиск максимальной производительности"
Это означает, что мы должны увеличивать нагрузку на систему до тех пор, пока не будут нарушены критерии успешной работы системы (обычно это время отклика или процент ошибок).
Но большинство систем, которые мы тестируем уже используются на проде. Или мы тестируем их не в первый раз.
А это значит, что мы и так знаем: нагрузку на уровне Х система держит. А вот насколько бОльшую нагрузку выдержит система - это вопрос, ответ на который нужно найти в ходе теста.
Для тестировщика это означает, что тест должен начаться с подачи той нагрузки, с которой система заведомо справляется (например, с 100% продуктивной нагрузки) - и "шагать" наверх.
Также стоит объяснить, почему мы увеличиваем нагрузку ступеньками: дело в том, что иногда показатели системы меняются не сразу после увеличения нагрузки, а с некоторой задержкой. Участки теста с стабильной нагрузкой лучше подходят для анализа поведения системы под такой нагрузкой.
С другой стороны, зачастую нам бывает и вовсе не интересно, как ведёт себя система под возрастающей нагрузкой, ведь на проде нагрузка обычно увеличивается в течение нескольких часов, а в тестах мы увеличиваем нагрузку гораздо быстрее, и, как следствие, вовсе не анализируем поведение системы в момент разгона на ступеньки - даже наоборот, анализируем только часть ступенек нагрузки - когда работа системы стабилизировалась после увеличения нагрузки (а для исследований быстрого роста нагрузки служит отдельный вид тестов - стресс-тесты).

Но, хотя наши тесты похожы, они зачастую отличаются: 
* Новый релиз тестируемой системы стал более производительным, и теперь тест можно начинать сразу с 150% продуктивной нагрузки. 
* Увеличились требования к точности результатов, и теперь нам нужны ступеньки не по 10% профиля, а по 5%. Или наоборот, по 20%.
* Система долго стабилизируется, и нужно увеличить длительность ступенек с 5 до 15 минут
* и так далее...

Раньше каждый раз, как нам был нужен новый тест - приходилось менять множество настроек в тест-планах Jmeter. 
Это было неудобно, кроме того каждый раз была вероятность человеческой ошибки.

С использованием JmeterSmartScenario достаточно указать параметры ДАННОГО теста - и все требуемые параметры будут рассчитаны автоматически, а вам остаётся только наблюдать за ходом теста.

# Как это работает?
После запуска теста отрабатывает setUp Thread Group, содержащая Groovy-скрипт, который:
1) Считывает построчно файл с "профилем", в котором указаны постоянные параметры:
* Имя операции
* Количество операций в час для 100% профиля
* Время, за которое операция успевает выполниться (стоит указывать с запасом, т.к. под нагрузкой время выполнения обычно увеличивается)
* Количество генераторов нагрузки, с которых будет выполняться эта операция (об этом я расскажу подробнее ниже).

2) Расчитываются количество потоков, необходимых для подачи заданной нагрузки а также интенсивность, с какой должен работать каждый VU.
Расчитанные параметры кладутся в Property с именами, состоящими из имени операции и суффикса:

* threadGroup_start - количество потоков на первой ступени теста
* threadGroup_add_thread - количество потоков, добавляемых на каждой ступени теста
* threadGroup_throughtput - количество операций, выполняемых в минуту каждым потоком

Также расчитываются и кладутся в Property параметры, одинаковые для всех тред-групп:
* №_init_delay - времени с момента старта теста до начала каждой ступени теста
* №_length - время с начала каждой ступени до конца теста

3) Эти параметры используются в настройках тест-плана:
* Для управления количеством потоков используется Ultimate Thread Group (устанавливается в составе плагина [Custom Thread Groups](https://jmeter-plugins.org/wiki/UltimateThreadGroup/))
* Для управления интенсивностью работы каждого потока используется Constant Throughput Timer (входит в состав Jmeter)

# Как мне начать использовать "JmeterSmartScenario"?
1) Скачайте в одну папку файлы JmeterSmartScenario.jmx, calc_test_param.groovy, profile.txt (в предоставленном примере используются 2 тред-группы). 
2) Откройте файл profile.txt, укажите ваши параметры: имена операций для начала предлагаю оставить их как есть, а остальные параметры укажите ваши:
* интенсивность (оп/ч)
* время выполнения операций (в секундах)
* количество генераторов нагрузки (если у вас НЕ распределённый тест - укажите "1")
4) Откройте JmeterSmartScenario.jmx, и после семплера "Flow Action Control" добавьте свои семплеры, транзакции и так далее (кстати, я все скрипты сохраняю в отдельные файлы как "Test Fragment", а в JmeterSmartScenario.jmx добавляю только Include Controller, ссылающийся на файл с конкретным скриптом).


# Ок, а как мне добавить новые тред-группы в "JmeterSmartScenario"?
Оох. 
Достаточно удобного способа я и сам не придумал.

Порядок действий такой:
1) Добавьте строчку в файл profile.txt, укажите все параметры через запятую.
2) Сдублируйте одну из имеющихся тред-групп
3) В настройках UltimateThreadGroup измените префикс в имени переменных в столбце "Start Thread Count": укажите имя операции так, как оно написано в файле profile.txt. Суффиксы \_start и \_add_thread оставьте. 
Обратите внимание! Как  называется сама тред-группа - не важно!
4) Разверните дерево: [ тред-группа => Flow Control Action => Constant Throughput Timer ], измените префикс в имени переменной: укажите имя операции так, как оно написано в файле profile.txt. Суффикс \_throughtput оставьте.

